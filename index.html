<html>
 <head>
     <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
     <style>
            .container {
              height: 200px;
              position: relative;
            }
            
            .vertical-center {
              margin: 0;
              position: absolute;
              top: 50%;
              left: 50%;
              -ms-transform: translate(-50%, -50%);
              transform: translate(-50%, -50%);
            }
            
            .horizontal-center {
              margin: 0;
              position: absolute;
              left: 50%;
              -ms-transform: translate(-50%, 0);
              transform: translate(-50%, 0);
            }
            
            .center {
             display: flex;
              justify-content: center;
              align-items: center;
              height: 200px;
            }
            label {
              display: inline-block;
              width: 140px;
              text-align: right;
            }
        </style>
 </head>
 <body>
    <script src="https://www.puck-js.com/puck.js"></script>
    <h1>Nanosensor for Safety Monitoring</h1>
    
    <div class="block" style="margin:20">
            <button onclick="myInterval = setInterval(myTimer, 1000);">start data log</button>
            <button onclick="clearInterval(myInterval);">stop data log</button>
            <br>
            </div>


        
    <div class="block" style="margin:10">

    	<canvas id="myChart" style="width:100%;max-width:700px"></canvas>


	 <div style="margin-top:600">
<div style="margin:20">
        <button onclick="Puck.eval('digitalWrite(LED1, 1), setInterval(function() {  digitalWrite(LED1, 0) }, 1000)')">test Eval!</button>
        <!-- button onclick="Puck.eval('getData()', function(d) {document.getElementById('sensor_data').value=d;});">get data!</button -->
	<button onclick="Puck.eval('analogRead(D31)', function(d) {document.getElementById('sensor_data').value=d;});">get data!</button>
    </div>
<div class="block" style="margin:10">
                <label>Sensor signal :</label><input id="sensor_data" type="text" value="0" disabled>
            </div>
	<div class="block" style="margin:10">
             <label>a :</label><input id="a" type="number" value="0.6"><br>
             <label>b :</label><input id="b" type="number" value="0.05"><br>
             <label>c :</label><input id="c" type="number" value="100"><br>
	     <label>smoothing degree - alpha :</label><input id="alpha" type="number" value="0.7" min="0" max="0.999999"><br>
            </div>
	<button onclick="clearData();">Restart</button>
	 </div>
	 
<script
src="https://cdn.jsdelivr.net/npm/chart.js">
</script>
<script>

//var real_time_data = [];
//var ma_data = [];

const max_points = 1000;
var xi=-1;

var ctx = document.getElementById("myChart").getContext("2d");

var myChart = new Chart(ctx, {
  type: "line",
  data: {
    datasets: [
      {
        label: 'real-time',
        pointRadius: 4,
        pointBackgroundColor: "rgb(0,0,255)",
        data: []  // Data for the real-time dataset
      },
      {
        label: 'smoothed',
        pointRadius: 4,
        borderColor: 'rgb(75, 192, 192)',  // Line color for smoothed data
        pointBackgroundColor: "rgb(0,255,255)",
        data: []  // Data for the smoothed dataset
      }
    ]
  },
  options: {
    plugins: {
      legend: {
        display: true,
        position: 'right'  // Legend placement
      }
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'Time (s)',
          color: 'black',
          font: {
            size: 14 // Adjusted font size for the X-axis title
          }
        }
      },
      y: {
        suggestedMin: 0,  // Minimum value for Y-axis
        suggestedMax: 250,  // Maximum value for Y-axis
        title: {
          display: true,
          text: 'Ammonia concentration (ppm)',
          color: 'black',
          font: {
            size: 14  // Adjusted font size for the Y-axis title
          }
        },
        ticks: {
          beginAtZero: true  // Ensure Y-axis begins at zero
        }
      }
    }
  }
});

console.log(myChart.options)
const average = array => array.reduce((a, b) => a + b) / array.length;

let smoothedValue = 0;

function exp_smooth(newDataPoint, smoothedV, alpha) {
    return (1 - alpha) * newDataPoint + alpha * smoothedV
} 

function addData(chart, label, newData) {
    chart.data.labels.push(newData.x);
    //chart.data.datasets.forEach((dataset) => {
     let a = document.getElementById('a').value;
     let b = document.getElementById('b').value;
     let c = document.getElementById('c').value;
     let shifted_y = (newData.y - a) / b * c;
     chart.data.datasets[0].data.push(shifted_y);
        //if (dataset.data.length > max_points){
            //dataset.data.shift();
        //}
    //});
	//let arr = chart.data.datasets[0].data;
	//let arr2 = arr.slice(Math.max(arr.length - 2, 0));
	//chart.data.datasets[1].data.push(exp_smooth(arr2));
	//console.log(average(arr2));
	//console.log(exp_smooth(arr2));
	
	let l0 = chart.data.datasets[0].data.length
	let l1 = chart.data.datasets[1].data.length
	smoothedValue = shifted_y;
	let alpha = document.getElementById('alpha').value;
	//console.log('alpha',alpha)
	if (l1 > 0) {
		smoothedValue = alpha * chart.data.datasets[1].data[l1-1] + (1 - alpha) * chart.data.datasets[0].data[l0-1];
	}
	
	chart.data.datasets[1].data.push(smoothedValue)
	//console.log('smoothedArray',chart.data.datasets[1].data)

	chart.options.scales.y.max = 250;
	chart.options.scales.y.min = 0;
    chart.update();
	
}

function myTimer() {
          //Puck.eval('getData()', function(d) {
	Puck.eval('analogRead(D31)', function(d) {
              document.getElementById('sensor_data').value=d;
              xi = xi + 1;
              //xyValues.push({x:xi,y:Number(d)});
              addData(myChart, [], {x:xi,y:Number(d)});
          });
        }

function clearData() {
	// Assuming 'myChart' is your chart instance
	myChart.data.datasets.forEach((dataset) => {
  		dataset.data = []; // Clear the data
	});

	myChart.options.scales.y.max = 250;
	myChart.options.scales.y.min = 0;

	// Optionally, you can also clear the labels if necessary:
	myChart.data.labels = [];

	// Update the chart to reflect the changes
	myChart.update();
  }
</script>

 </body>
</html>
